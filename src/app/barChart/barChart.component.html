<div class="ctrl-bar">

  <div class="ctrl-bar__dates">
    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="date-field">
      <mat-label>Début</mat-label>
      <input matInput
             [value]="startDate"
             [matDatepicker]="pickerStart"
             (dateInput)="changeDate('start', $event)"
             (dateChange)="changeDate('start', $event)"/>
      <mat-datepicker-toggle matSuffix [for]="pickerStart"></mat-datepicker-toggle>
      <mat-datepicker #pickerStart [startAt]="startDate"></mat-datepicker>
    </mat-form-field>

    <span class="ctrl-bar__arrow">→</span>

    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="date-field">
      <mat-label>Fin</mat-label>
      <input matInput
             [value]="endDate"
             [matDatepicker]="pickerEnd"
             (dateInput)="changeDate('end', $event)"
             (dateChange)="changeDate('end', $event)"/>
      <mat-datepicker-toggle matSuffix [for]="pickerEnd"></mat-datepicker-toggle>
      <mat-datepicker #pickerEnd [startAt]="endDate"></mat-datepicker>
    </mat-form-field>
  </div>

  <div class="ctrl-bar__actions">
    <button mat-stroked-button class="btn--refresh" (click)="refreshStat()">
      <mat-icon>refresh</mat-icon>
      Actualiser
    </button>
    <button mat-flat-button class="btn--export" (click)="exportStat()">
      <mat-icon>download</mat-icon>
      Exporter
    </button>
  </div>

</div>

<div #chartContainer class="chart-container">
  <svg width="100%" height="100%">

    @for (tick of yTicks; track $index) {
      <line [attr.x1]="axis.yX" [attr.y1]="tick.y"
            [attr.x2]="axis.xX2" [attr.y2]="tick.y"
            stroke="#e0e0e0" stroke-width="1"/>
      <text [attr.x]="axis.yX - 5" [attr.y]="tick.y + 4"
            text-anchor="end" font-size="11" fill="#666">{{ tick.label }}</text>
    }

    @for (bar of bars; track bar.label) {
      <rect [attr.x]="bar.x" [attr.y]="bar.y"
            [attr.width]="bar.w" [attr.height]="bar.h"
            fill="#3cba9f" style="cursor: pointer"
            (mouseenter)="onBarMouseEnter(bar)"
            (mouseleave)="onBarMouseLeave()"
            (touchstart)="onBarTouchStart(bar)"/>
      @if (bar.showLabel) {
        <text [attr.x]="bar.lx" [attr.y]="bar.ly"
              [attr.transform]="bar.lt"
              text-anchor="end" font-size="10" fill="#666">{{ bar.label }}</text>
      }
    }

    @if (activeBar) {
      <rect [attr.x]="tooltipCx - 38" [attr.y]="tooltipTy"
            width="76" height="28" rx="14"
            fill="#1a1a1a"/>
      <polygon [attr.points]="tooltipArrow" fill="#1a1a1a"/>
      <text [attr.x]="tooltipCx" [attr.y]="tooltipTy + 18"
            text-anchor="middle" font-size="12" fill="white">{{ activeBar.tooltip }}</text>
    }

    <line [attr.x1]="axis.yX"  [attr.y1]="axis.yY1"
          [attr.x2]="axis.yX"  [attr.y2]="axis.yY2"
          stroke="#999" stroke-width="1"/>
    <line [attr.x1]="axis.yX"  [attr.y1]="axis.xY"
          [attr.x2]="axis.xX2" [attr.y2]="axis.xY"
          stroke="#999" stroke-width="1"/>

  </svg>
</div>
